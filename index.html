<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ðŸ›’ Ä°kinciEl Fiyat KarÅŸÄ±laÅŸtÄ±rma - Sahibinden, Dolap, Letgo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* MOBÄ°L UYUMLU STÄ°LLER */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); min-height: 100vh; color: #333; }
        
        /* Container */
        .container { max-width: 100%; padding: 15px; }
        
        /* Header */
        .header { text-align: center; color: white; padding: 25px 15px; }
        .header h1 { font-size: 1.8rem; margin-bottom: 8px; }
        .header p { opacity: 0.9; font-size: 0.95rem; }
        .header .subtitle { font-size: 0.9rem; opacity: 0.8; margin-top: 5px; }
        
        /* Arama Kutusu */
        .search-container { background: rgba(255, 255, 255, 0.95); border-radius: 20px; padding: 20px; margin: 20px 0; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .search-box { display: flex; margin-bottom: 15px; }
        #searchInput { flex: 1; border: 2px solid #e0e0e0; padding: 15px; border-radius: 10px 0 0 10px; font-size: 16px; outline: none; }
        #searchBtn { background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color: white; border: none; padding: 0 25px; border-radius: 0 10px 10px 0; font-weight: bold; cursor: pointer; }
        
        /* HÄ±zlÄ± Aramalar */
        .quick-search-container { display: flex; flex-wrap: wrap; gap: 10px; margin: 15px 0; }
        .quick-search-btn { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.3); color: white; padding: 10px 15px; border-radius: 20px; font-size: 14px; cursor: pointer; backdrop-filter: blur(10px); }
        
        /* Site KartlarÄ± */
        .site-cards { display: grid; grid-template-columns: 1fr; gap: 15px; margin-top: 20px; }
        @media (min-width: 768px) { .site-cards { grid-template-columns: repeat(3, 1fr); } }
        
        .site-card { background: white; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .site-icon { font-size: 40px; margin-bottom: 15px; }
        .site-name { font-weight: bold; font-size: 1.2rem; margin-bottom: 10px; }
        .site-description { color: #666; font-size: 0.9rem; margin-bottom: 15px; }
        .visit-site-btn { display: inline-block; background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; font-weight: bold; margin-top: 10px; }
        
        /* SonuÃ§lar */
        .results-container { display: none; margin-top: 20px; }
        .market-tabs { display: flex; background: white; border-radius: 10px; overflow: hidden; margin-bottom: 15px; }
        .market-tab { flex: 1; text-align: center; padding: 15px; cursor: pointer; border-bottom: 3px solid transparent; }
        .market-tab.active { border-bottom: 3px solid #6a11cb; font-weight: bold; color: #6a11cb; }
        .product-list { display: none; }
        .product-list.active { display: block; }
        
        /* ÃœrÃ¼n KartlarÄ± */
        .product-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 5px solid #6a11cb; box-shadow: 0 3px 10px rgba(0,0,0,0.08); }
        .product-title { font-weight: 600; margin-bottom: 8px; color: #333; font-size: 15px; }
        .product-price { font-size: 1.3rem; font-weight: 700; color: #00b894; margin-bottom: 5px; }
        .product-meta { font-size: 0.8rem; color: #666; }
        .product-source { display: inline-block; background: #eee; padding: 3px 10px; border-radius: 12px; font-size: 0.75rem; margin-top: 5px; }
        .product-link { display: inline-block; background: #2575fc; color: white; padding: 8px 15px; border-radius: 6px; text-decoration: none; margin-top: 10px; font-size: 14px; }
        
        /* Loading */
        .loading { text-align: center; padding: 30px; color: white; display: none; }
        .loading i { font-size: 40px; margin-bottom: 15px; display: block; }
        
        /* Error */
        .error { background: #ffebee; color: #c62828; padding: 15px; border-radius: 10px; text-align: center; margin: 15px 0; display: none; }
        
        /* Footer */
        .footer { text-align: center; color: white; padding: 20px; margin-top: 30px; font-size: 0.9rem; opacity: 0.8; }
        
        /* Direct Site Links */
        .direct-links { background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 20px; margin-top: 20px; display: none; }
        .direct-link { display: block; background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; text-decoration: none; color: #333; border-left: 4px solid #ff9800; }
    </style>
</head>
<body>
    <div class="container">
        <!-- BaÅŸlÄ±k -->
        <div class="header">
            <h1><i class="fas fa-balance-scale"></i> Ä°kinciEl Fiyat AsistanÄ±</h1>
            <p>Sahibinden, Dolap, Letgo - CanlÄ± Fiyat KarÅŸÄ±laÅŸtÄ±rma</p>
            <p class="subtitle">Otomatik fiyat Ã§ekilir â€¢ Mobil uyumlu â€¢ Direkt site linkleri</p>
        </div>
        
        <!-- Arama Kutusu -->
        <div class="search-container">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Ã–rn: iPhone 13, RTX 3060, BuzdolabÄ±..." autocomplete="off">
                <button id="searchBtn"><i class="fas fa-search"></i> ARA</button>
            </div>
            
            <!-- HÄ±zlÄ± Aramalar -->
            <div class="quick-search-container">
                <button class="quick-search-btn" data-query="iphone 13">ðŸ“± iPhone 13</button>
                <button class="quick-search-btn" data-query="rtx 3060">ðŸŽ® RTX 3060</button>
                <button class="quick-search-btn" data-query="macbook air">ðŸ’» MacBook Air</button>
                <button class="quick-search-btn" data-query="samsung tv">ðŸ“º Samsung TV</button>
                <button class="quick-search-btn" data-query="buzdolabÄ±">ðŸ§Š BuzdolabÄ±</button>
            </div>
        </div>
        
        <!-- Site KartlarÄ± (DoÄŸrudan Linkler) -->
        <div class="site-cards">
            <div class="site-card">
                <div class="site-icon" style="color: #ff6b35;">
                    <i class="fas fa-store"></i>
                </div>
                <div class="site-name">Sahibinden</div>
                <div class="site-description">TÃ¼rkiye'nin en bÃ¼yÃ¼k ikinci el pazarÄ±</div>
                <a href="https://www.sahibinden.com" target="_blank" class="visit-site-btn">
                    <i class="fas fa-external-link-alt"></i> Siteye Git
                </a>
            </div>
            
            <div class="site-card">
                <div class="site-icon" style="color: #00a8ff;">
                    <i class="fas fa-shopping-bag"></i>
                </div>
                <div class="site-name">Dolap</div>
                <div class="site-description">Giyim, elektronik, dekorasyon</div>
                <a href="https://dolap.com" target="_blank" class="visit-site-btn">
                    <i class="fas fa-external-link-alt"></i> Siteye Git
                </a>
            </div>
            
            <div class="site-card">
                <div class="site-icon" style="color: #9c27b0;">
                    <i class="fas fa-bolt"></i>
                </div>
                <div class="site-name">Letgo</div>
                <div class="site-description">Yerel ikinci el ilanlarÄ±</div>
                <a href="https://www.letgo.com" target="_blank" class="visit-site-btn">
                    <i class="fas fa-external-link-alt"></i> Siteye Git
                </a>
            </div>
        </div>
        
        <!-- Loading -->
        <div class="loading" id="loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Fiyatlar aranÄ±yor...</p>
            <p style="font-size: 0.9rem; opacity: 0.7;">Sahibinden, Dolap, Letgo taranÄ±yor</p>
        </div>
        
        <!-- Hata MesajÄ± -->
        <div class="error" id="errorContainer"></div>
        
        <!-- SonuÃ§lar -->
        <div class="results-container" id="resultsContainer">
            <div class="market-tabs">
                <div class="market-tab active" data-market="sahibinden">
                    <i class="fas fa-store"></i> Sahibinden
                </div>
                <div class="market-tab" data-market="dolap">
                    <i class="fas fa-shopping-bag"></i> Dolap
                </div>
                <div class="market-tab" data-market="letgo">
                    <i class="fas fa-bolt"></i> Letgo
                </div>
            </div>
            
            <!-- SonuÃ§ Listeleri -->
            <div id="sahibindenResults" class="product-list active"></div>
            <div id="dolapResults" class="product-list"></div>
            <div id="letgoResults" class="product-list"></div>
        </div>
        
        <!-- DoÄŸrudan Site Linkleri (Fallback) -->
        <div class="direct-links" id="directLinks">
            <h3 style="margin-bottom: 15px; color: #333;">ðŸ“± DoÄŸrudan Sitelerde Ara:</h3>
            <a href="#" id="directSahibinden" class="direct-link" target="_blank">
                <i class="fas fa-store"></i> Sahibinden'de ara: <span id="querySahibinden"></span>
            </a>
            <a href="#" id="directDolap" class="direct-link" target="_blank">
                <i class="fas fa-shopping-bag"></i> Dolap'ta ara: <span id="queryDolap"></span>
            </a>
            <a href="#" id="directLetgo" class="direct-link" target="_blank">
                <i class="fas fa-bolt"></i> Letgo'da ara: <span id="queryLetgo"></span>
            </a>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            <p>Ä°kinciEl Fiyat KarÅŸÄ±laÅŸtÄ±rma â€¢ Mobil Uyumlu â€¢ GerÃ§ek ZamanlÄ± Fiyatlar</p>
            <p style="font-size: 0.8rem; margin-top: 5px;">Â© 2024 â€¢ Otomatik fiyat Ã§ekme + Direkt site linkleri</p>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // ==================== KONFÄ°GÃœRASYON ====================
        const CONFIG = {
            // Backend URL - 404 hatasÄ± veriyorsa LOCAL'e Ã§evir
            BACKEND_URL: 'https://pc-scraper-backend.onrender.com',
            // Veya local test iÃ§in: 'http://localhost:3000'
            
            // Timeout sÃ¼resi (ms)
            TIMEOUT: 10000,
            
            // Fallback: Backend Ã§alÄ±ÅŸmazsa doÄŸrudan site linklerini gÃ¶ster
            USE_FALLBACK: true
        };
        
        // ==================== DOM ELEMENTLERÄ° ====================
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const loading = document.getElementById('loading');
        const errorContainer = document.getElementById('errorContainer');
        const resultsContainer = document.getElementById('resultsContainer');
        const directLinks = document.getElementById('directLinks');
        
        // ==================== BACKEND TESTÄ° ====================
        async function testBackend() {
            console.log('ðŸ” Backend test ediliyor:', CONFIG.BACKEND_URL);
            try {
                const response = await fetch(`${CONFIG.BACKEND_URL}/api/health`, {
                    signal: AbortSignal.timeout(5000)
                });
                return response.ok;
            } catch (error) {
                console.log('âŒ Backend Ã§alÄ±ÅŸmÄ±yor:', error.message);
                return false;
            }
        }
        
        // ==================== ANA ARAMA FONKSÄ°YONU ====================
        async function searchProducts(query) {
            // UI'Ä± sÄ±fÄ±rla
            loading.style.display = 'block';
            errorContainer.style.display = 'none';
            resultsContainer.style.display = 'none';
            directLinks.style.display = 'none';
            clearResults();
            
            console.log(`ðŸ” AranÄ±yor: "${query}"`);
            
            // 1. Ã–NCE BACKEND'Ä° TEST ET
            const backendWorking = await testBackend();
            
            if (!backendWorking && CONFIG.USE_FALLBACK) {
                // Backend Ã§alÄ±ÅŸmÄ±yor, FALLBACK moda geÃ§
                console.log('âš ï¸ Backend Ã§alÄ±ÅŸmÄ±yor, fallback mode');
                showFallbackLinks(query);
                loading.style.display = 'none';
                return;
            }
            
            try {
                // 2. BACKEND'TEN VERÄ° Ã‡EK
                console.log('ðŸ“¡ Backend\'e istek atÄ±lÄ±yor...');
                const response = await fetch(`${CONFIG.BACKEND_URL}/api/search/${encodeURIComponent(query)}`, {
                    signal: AbortSignal.timeout(CONFIG.TIMEOUT)
                });
                
                if (!response.ok) {
                    throw new Error(`Backend hatasÄ± (${response.status})`);
                }
                
                const data = await response.json();
                console.log('âœ… Veri alÄ±ndÄ±:', data);
                
                if (data.success) {
                    // 3. VERÄ°YÄ° GÃ–STER
                    displayResults(data);
                    resultsContainer.style.display = 'block';
                } else {
                    throw new Error(data.error || 'Bilinmeyen hata');
                }
                
            } catch (error) {
                console.error('âŒ Hata:', error);
                
                // 4. HATA DURUMUNDA FALLBACK GÃ–STER
                if (CONFIG.USE_FALLBACK) {
                    showFallbackLinks(query);
                } else {
                    showError(`BaÄŸlantÄ± hatasÄ±: ${error.message}`);
                }
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // ==================== SONUÃ‡LARI GÃ–STER ====================
        function displayResults(data) {
            // Sahibinden sonuÃ§larÄ±
            if (data.sahibinden && data.sahibinden.length > 0) {
                const sorted = [...data.sahibinden].sort((a, b) => a.price - b.price);
                displayProductList('sahibinden', sorted);
            } else {
                document.getElementById('sahibindenResults').innerHTML = 
                    '<div class="product-card"><p>Sahibinden\'de Ã¼rÃ¼n bulunamadÄ±.</p></div>';
            }
            
            // Dolap sonuÃ§larÄ±
            if (data.dolap && data.dolap.length > 0) {
                const sorted = [...data.dolap].sort((a, b) => a.price - b.price);
                displayProductList('dolap', sorted);
            } else {
                document.getElementById('dolapResults').innerHTML = 
                    '<div class="product-card"><p>Dolap\'ta Ã¼rÃ¼n bulunamadÄ±.</p></div>';
            }
            
            // Letgo sonuÃ§larÄ±
            const letgoContainer = document.getElementById('letgoResults');
            if (data.letgo && data.letgo.title) {
                letgoContainer.innerHTML = `
                    <div class="product-card" style="border-left-color: #9c27b0;">
                        <div class="product-title"><i class="fas fa-bolt"></i> ${data.letgo.title}</div>
                        <div class="product-price">${data.letgo.formattedPrice || data.letgo.price + ' TL'}</div>
                        <div class="product-meta">${data.letgo.note || 'Letgo - En uygun ilan'}</div>
                        <span class="product-source">LETGO</span><br>
                        <a href="${data.letgo.link}" target="_blank" class="product-link">
                            Ä°lana Git <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                `;
            } else {
                letgoContainer.innerHTML = '<div class="product-card"><p>Letgo\'da Ã¼rÃ¼n bulunamadÄ±.</p></div>';
            }
            
            // Fallback linkleri de gÃ¶ster (kullanÄ±cÄ± isterse direkt siteye gidebilir)
            showFallbackLinks(data.query || searchInput.value);
        }
        
        // ==================== ÃœRÃœN LÄ°STESÄ° GÃ–STER ====================
        function displayProductList(marketName, products) {
            const container = document.getElementById(`${marketName}Results`);
            let html = '';
            
            products.forEach(product => {
                html += `
                    <div class="product-card">
                        <div class="product-title">${product.title}</div>
                        <div class="product-price">${product.formattedPrice || product.price.toLocaleString('tr-TR') + ' TL'}</div>
                        <div class="product-meta">
                            ${product.location ? `<i class="fas fa-map-marker-alt"></i> ${product.location}` : ''}
                            ${product.date ? ` â€¢ ${product.date}` : ''}
                        </div>
                        <span class="product-source">${marketName.toUpperCase()}</span><br>
                        <a href="${product.link}" target="_blank" class="product-link">
                            Ä°lana Git <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ==================== FALLBACK: DÄ°REKT SÄ°TE LÄ°NKLERÄ° ====================
        function showFallbackLinks(query) {
            const encodedQuery = encodeURIComponent(query);
            const plusQuery = query.replace(/ /g, '+');
            
            // Linkleri gÃ¼ncelle
            document.getElementById('directSahibinden').href = 
                `https://www.sahibinden.com/arama?query=${encodedQuery}&sorting=price_asc`;
            document.getElementById('querySahibinden').textContent = query;
            
            document.getElementById('directDolap').href = 
                `https://dolap.com/ara?q=${plusQuery}`;
            document.getElementById('queryDolap').textContent = query;
            
            document.getElementById('directLetgo').href = 
                `https://www.letgo.com/tr-tr/arama?q=${plusQuery}`;
            document.getElementById('queryLetgo').textContent = query;
            
            // GÃ¶ster
            directLinks.style.display = 'block';
        }
        
        // ==================== YARDIMCI FONKSÄ°YONLAR ====================
        function showError(message) {
            errorContainer.innerHTML = `<p><i class="fas fa-exclamation-triangle"></i> ${message}</p>`;
            errorContainer.style.display = 'block';
        }
        
        function clearResults() {
            ['sahibinden', 'dolap', 'letgo'].forEach(market => {
                document.getElementById(`${market}Results`).innerHTML = '';
            });
        }
        
        // ==================== SEKME DEÄžÄ°ÅžTÄ°RME ====================
        document.querySelectorAll('.market-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Aktif sekmeyi deÄŸiÅŸtir
                document.querySelectorAll('.market-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Ä°lgili listeyi gÃ¶ster
                const market = this.getAttribute('data-market');
                document.querySelectorAll('.product-list').forEach(list => list.classList.remove('active'));
                document.getElementById(`${market}Results`).classList.add('active');
            });
        });
        
        // ==================== OLAY DÄ°NLEYÄ°CÄ°LERÄ° ====================
        // Arama butonu
        searchBtn.addEventListener('click', () => {
            const query = searchInput.value.trim();
            if (query) searchProducts(query);
            else showError('LÃ¼tfen bir Ã¼rÃ¼n adÄ± yazÄ±n.');
        });
        
        // Enter tuÅŸu
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchBtn.click();
        });
        
        // HÄ±zlÄ± arama butonlarÄ±
        document.querySelectorAll('.quick-search-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                searchInput.value = this.getAttribute('data-query');
                searchProducts(searchInput.value);
            });
        });
        
        // ==================== SAYFA YÃœKLENÄ°NCE ====================
        window.addEventListener('load', async () => {
            console.log('ðŸš€ Ä°kinciEl Fiyat AsistanÄ± hazÄ±r');
            
            // Backend durumunu kontrol et
            const backendOk = await testBackend();
            if (!backendOk) {
                console.log('â„¹ï¸ Backend Ã§alÄ±ÅŸmÄ±yor, fallback mod aktif');
                showError('Backend ÅŸu anda Ã§alÄ±ÅŸmÄ±yor. DoÄŸrudan site linkleri kullanÄ±lacak.');
            }
            
            // Ã–rnek Ã¼rÃ¼n gÃ¶stermek iÃ§in (isteÄŸe baÄŸlÄ±)
            // searchInput.value = 'iphone 13';
            // searchBtn.click();
        });
        
        // Timeout polyfill
        if (!AbortSignal.timeout) {
            AbortSignal.timeout = function(ms) {
                const controller = new AbortController();
                setTimeout(() => controller.abort(new DOMException('TimeoutError', 'TimeoutError')), ms);
                return controller.signal;
            };
        }
    </script>
</body>
</html>
